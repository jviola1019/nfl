---
title: "NFL Model Update: Professional Calibration & UI Modernization"
author: "NFL Prediction Model Team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary of Changes

This document summarizes the significant updates made to the NFL prediction model, focusing on two major areas:

1. **Professional Calibration** - Addressing overconfidence issues identified in model output
2. **UI Modernization** - Claude-inspired design refresh with improved transparency

---

## 1. Professional Calibration Updates

### Problem Identified

A data scientist review identified several critical issues with the model's betting recommendations:

- **Unrealistically large EV edges** (27%, 21%, 17%) - Professional sharps rarely find edges >3-5%
- **Hit rate too high** (69% of games showing +EV) - Should be 10-20%
- **Stake sizing not scaling properly** with Kelly criterion
- **Missing professional model indicators** (CLV, Brier scores, calibration metrics)

### Solutions Implemented

#### 1.1 Probability Shrinkage (60% toward market)

**File:** `NFLmarket.R` (lines ~642-651)

```r
shrink_probability_toward_market <- function(model_prob, market_prob, shrinkage = 0.6) {
  # Weighted average: higher shrinkage = more weight on market
  shrunk <- (1 - shrinkage) * model_prob + shrinkage * market_prob
  clamp_probability(shrunk)
}
```

**Rationale:** NFL markets are extremely efficient. Raw model probabilities that diverge significantly from market are almost certainly overfit. We shrink 60% toward market consensus to produce more realistic betting recommendations.

#### 1.2 Conservative Kelly Staking (1/8 Kelly with edge skepticism)

**File:** `NFLmarket.R` (lines ~667-699)

```r
conservative_kelly_stake <- function(prob, odds,
                                     kelly_fraction = 0.125,  # 1/8 Kelly
                                     max_edge = 0.10,         # 10% max believable edge
                                     max_stake = 0.02) {      # 2% max stake
  # Standard Kelly formula
  kelly <- (prob * b - (1 - prob)) / b

  # Edge skepticism: larger edges are more likely model errors
  edge_penalty <- case_when(
    kelly <= max_edge ~ 1.0,
    kelly <= max_edge * 2 ~ 0.5,   # 50% penalty for 2x max edge
    kelly <= max_edge * 3 ~ 0.25,  # 75% penalty for 3x max edge
    TRUE ~ 0.1                      # 90% penalty for extreme edges
  )

  stake <- kelly * kelly_fraction * edge_penalty
  pmax(0, pmin(stake, max_stake))
}
```

**Rationale:** Full Kelly is too aggressive and assumes perfect probability estimates. We implement:

- **1/8 Kelly** (12.5%) to reduce variance
- **Edge skepticism** - progressively penalize implausibly large edges
- **Maximum stake cap** of 2% per bet

#### 1.3 Edge Classification System

**File:** `NFLmarket.R` (lines ~705-714)

```r
classify_edge_magnitude <- function(edge) {
  case_when(
    edge <= 0.05 ~ "realistic",      # 0-5%: plausible professional edge
    edge <= 0.10 ~ "optimistic",     # 5-10%: possible but rare
    edge <= 0.15 ~ "suspicious",     # 10-15%: likely model error
    TRUE ~ "implausible"             # >15%: almost certainly wrong
  )
}
```

**Display in Report:**
- `âœ“ OK` - Realistic edges (0-5%)
- `âš  High` - Optimistic edges (5-10%)
- `âš âš  Suspicious` - Suspicious edges (10-15%)
- `ðŸš« Implausible` - Almost certainly model errors (>15%)

---

## 2. UI Modernization Updates

### 2.1 Claude-Inspired Color Scheme

**File:** `NFLmarket.R` (CSS sections)

```css
:root {
  --claude-coral: #D97757;
  --claude-coral-light: #E89A7A;
  --claude-cream: #FAF9F6;
  --claude-warm-gray: #2D2A26;
  --claude-dark: #1A1815;
}
```

**Features:**
- Warm coral/terracotta accent colors
- Glass morphism effects with `backdrop-filter: blur()`
- Modern gradients and soft shadows
- Improved typography (Inter, SÃ¶hne fonts)

### 2.2 New Transparency Columns

| Column | Description |
|--------|-------------|
| `ML Implied Home %` | Raw moneyline-derived probability |
| `Edge Quality` | Classification of edge reliability |
| `Raw Prob Edge (pp)` | Unshrunked probability advantage (for reference) |

### 2.3 Blend Pick for Pass Games

- **Blend Pick** now shows the model's favorite team even for Pass games
- Indicated with asterisk (*): `TB*` means "TB is the favorite but no +EV bet exists"

---

## 3. Technical Implementation Details

### 3.1 Calculation Flow (Updated)

```
Raw Model Probabilities
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  60% Shrinkage Toward Market        â”‚
â”‚  shrunk_prob = 0.4*model + 0.6*mkt  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EV Calculation (Shrunk Probs)      â”‚
â”‚  EV = shrunk_prob * dec_odds - 1    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Conservative Kelly Staking         â”‚
â”‚  stake = kelly * 0.125 * penalty    â”‚
â”‚  (max 2% of bankroll)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edge Classification                â”‚
â”‚  realistic/optimistic/suspicious    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Key Parameters

| Parameter | Value | Rationale |
|-----------|-------|-----------|
| Shrinkage | 60% | High trust in market efficiency |
| Kelly Fraction | 12.5% (1/8) | Conservative for estimation error |
| Max Believable Edge | 10% | Professional sharps rarely exceed |
| Max Stake | 2% | Bankroll protection |

### 3.3 R 4.5.1 Compatibility

All code has been verified for R 4.5.1 compatibility:
- No deprecated tidyverse functions
- Safe column existence checks
- Fallback formatting for all display scenarios

---

## 4. Report Display Changes

### 4.1 New Disclaimer Section

Added prominent warning at top of report:

> **âš ï¸ CRITICAL: PROFESSIONAL CALIBRATION APPLIED**
>
> NFL betting markets are among the most efficient in sports. Professional sharps rarely find edges above 3-5%. This model applies:
> - 60% Probability Shrinkage
> - 1/8 Kelly Staking
> - Edge Skepticism (>10% edges penalized)
> - Max 2% Stake per bet

### 4.2 Updated Source Note

```
âš ï¸ CALIBRATED: 60% shrinkage toward market | 1/8 Kelly staking |
Edge skepticism applied | * = Pass game | âœ“OK=0-5% | âš High=5-10% |
âš âš Suspicious=10-15% | ðŸš«Implausible=>15%
```

---

## 5. Expected Impact

### Before Calibration
- Average displayed edge: ~15-27%
- Bets per week: 11 of 16 games (69%)
- Stake sizes: Based on raw Kelly

### After Calibration
- Average displayed edge: ~2-6%
- Bets per week: 3-5 of 16 games (~25%)
- Stake sizes: Conservative 1/8 Kelly with caps

**Key Insight:** If the calibrated model still shows >5% edges frequently, additional validation is needed:
- Backtest against closing lines (not opening)
- Track Closing Line Value (CLV)
- Paper trade for a full season

---

## 6. Files Modified

| File | Changes |
|------|---------|
| `NFLmarket.R` | Added calibration functions, updated calculations, modernized CSS |
| `update.Rmd` | This documentation file (new) |

---

## 7. Future Recommendations

1. **Implement CLV Tracking** - Track if model beats closing lines
2. **Add Brier Score Display** - Show calibration metrics in report
3. **Historical Backtest** - Run model against 3+ seasons of data
4. **Confidence Intervals** - Add uncertainty bands to predictions
5. **Market Movement Analysis** - Compare to line movements

---

*Document generated: `r Sys.time()`*
