)
res_blend <- res
res_blend$per_game <- per_game_with_blend %>%
dplyr::select(dplyr::all_of(base_cols))
if (!identical(names(res_blend$per_game), base_cols)) {
stop("Blended per-game table columns diverged from original structure after merge.")
}
type_mismatch <- purrr::map2_lgl(
base_per_game,
res_blend$per_game,
~ identical(typeof(.x), typeof(.y)) && identical(class(.x), class(.y))
)
if (!all(type_mismatch)) {
mismatch_cols <- names(base_per_game)[!type_mismatch]
stop(sprintf(
"Blended per-game table changed column types for: %s",
paste(mismatch_cols, collapse = ", ")
))
}
diff_cols <- base_cols[purrr::map_lgl(base_cols, ~ !identical(base_per_game[[.x]], res_blend$per_game[[.x]]))]
diff_cols <- setdiff(diff_cols, prob_col)
if (length(diff_cols)) {
stop(sprintf(
"Blended per-game table unexpectedly altered non-probability columns: %s",
paste(diff_cols, collapse = ", ")
))
}
inform(sprintf("res_blend structure verified; only %s differs from res$per_game.", prob_col))
if (nrow(res_blend$per_game) != orig_n_per_game) {
stop(sprintf(
"Blended per-game table changed row count from %d to %d after merge.",
orig_n_per_game, nrow(res_blend$per_game)
))
}
blend_keys <- res_blend$per_game %>%
dplyr::select(dplyr::all_of(blend_join_cols)) %>%
dplyr::distinct()
miss_from_blend <- base_keys %>%
dplyr::anti_join(blend_keys, by = blend_join_cols)
extra_in_blend <- blend_keys %>%
dplyr::anti_join(base_keys, by = blend_join_cols)
if (nrow(miss_from_blend) || nrow(extra_in_blend)) {
stop(sprintf(
"Blended per-game table does not align with original results: missing=%d, extra=%d",
nrow(miss_from_blend), nrow(extra_in_blend)
))
}
dup_blend <- res_blend$per_game %>%
dplyr::count(dplyr::across(dplyr::all_of(blend_join_cols))) %>%
dplyr::filter(.data$n > 1L)
if (nrow(dup_blend)) {
stop("Blended per-game table contains duplicate game/week combinations after merge; cannot run compare_to_market().")
}
cat("\n=== Blended vs market (paired, week-block bootstrap) ===\n")
cmp_blend <- compare_to_market(res_blend, sched)
# cmp_blend$overall$... has Brier/LogLoss and deltas; 95% CIs printed by the function
} else {
warning("Could not locate calibrated probability column on res$per_game; skipping blended market comparison.")
}
}
# Optional quick peeks:
if (exists("cmp_blend") && !is.null(cmp_blend)) {
print(cmp_blend$overall)
head(cmp_blend$by_season)
}
# ------------------ INTERACTIVE SLATE TABLE (reactable) ------------------
pretty_df <- final |>
separate_matchup_cols("matchup", c("away_team", "home_team"), sep = " @ ", remove = FALSE) |>
dplyr::left_join(
games_ready |>
dplyr::select(game_id, game_date, home_team, away_team, venue, dome, windy, cold, precip),
by = c("home_team","away_team", "date" = "game_date")
) |>
dplyr::mutate(
dow      = lubridate::wday(date, label = TRUE, abbr = TRUE),
# Model-only favorite and probabilities (calibrated 3-way)
fav_team_model = dplyr::if_else(home_win_prob_cal >= away_win_prob_cal, home_team, away_team),
fav_prob_model = pmax(home_win_prob_cal, away_win_prob_cal),
win_tier_model = dplyr::case_when(
fav_prob_model < 0.55 ~ "Coin flip (<55%)",
fav_prob_model < 0.65 ~ "Lean (55-65%)",
fav_prob_model < 0.75 ~ "Strong (65-75%)",
TRUE                  ~ "Heavy (75%+)"
),
# Blended (model + market) favorite/probabilities for comparison
fav_team_blend = dplyr::if_else(home_win_prob_blend >= away_win_prob_blend, home_team, away_team),
fav_prob_blend = pmax(home_win_prob_blend, away_win_prob_blend),
win_tier_blend = dplyr::case_when(
fav_prob_blend < 0.55 ~ "Coin flip (<55%)",
fav_prob_blend < 0.65 ~ "Lean (55-65%)",
fav_prob_blend < 0.75 ~ "Strong (65-75%)",
TRUE                  ~ "Heavy (75%+)"
),
# Preserve legacy names for downstream usage (now explicitly model-based)
fav_team = fav_team_model,
fav_prob = fav_prob_model,
win_tier = win_tier_model,
total_bucket = dplyr::case_when(
total_mean >= 50 ~ "Shootout (50+)",
total_mean <= 41 ~ "Grinder (<=41)",
total_mean >= 46 ~ "High (46-49.5)",
TRUE             ~ "Average (41.5-45.5)"
),
env = paste0(
dplyr::if_else(dplyr::coalesce(dome, FALSE), "Dome", "Outdoor"),
dplyr::if_else(dplyr::coalesce(windy, FALSE),  " - Wind",  ""),
dplyr::if_else(dplyr::coalesce(cold,  FALSE),  " - Cold",  ""),
dplyr::if_else(dplyr::coalesce(precip, FALSE), " - Precip", "")
),
Category = paste(win_tier, total_bucket, env, sep = " - ")
) |>
dplyr::arrange(date, dplyr::desc(fav_prob_blend))
rt_df <- pretty_df %>%
transmute(
Day = as.character(dow),
Date = format(date, "%b %d"),
Matchup = matchup,
`Home% (Blend 3-way)` = home_win_prob_blend,
`Away% (Blend 3-way)` = away_win_prob_blend,
`Home% (Blend 2-way)` = home_p_2w_blend,
`Away% (Blend 2-way)` = 1 - home_p_2w_blend,
`Home Median (Blend)` = home_median_blend,
`Away Median (Blend)` = away_median_blend,
`Total Median (Blend)` = total_median_blend
)
# spot-check a few probabilities
if (!quiet_mode) {
print(
final %>%
dplyr::select(matchup, home_win_prob_cal, away_win_prob_cal, tie_prob,
home_p_2w_cal, away_p_2w_cal) %>%
slice_head(n = 5)
)
}
if (reactable_available) {
# Render reactable
reactable::reactable(
rt_df,
searchable = TRUE,
pagination = TRUE,
defaultPageSize = 25,
striped = TRUE,
highlight = TRUE,
defaultSorted = list("Date" = "asc", "Home% (Blend 3-way)" = "desc"),
groupBy = "Day",
columns = list(
`Home% (Blend 3-way)` = reactable::colDef(
format = reactable::colFormat(percent = TRUE, digits = 1),
align = "center",
style = function(value) list(
background = pal_fav(value),
color = if (is.na(value) || value < 0.72) "black" else "white"
)
),
`Away% (Blend 3-way)` = reactable::colDef(format = reactable::colFormat(percent = TRUE, digits = 1), align = "center"),
`Home% (Blend 2-way)` = reactable::colDef(format = reactable::colFormat(percent = TRUE, digits = 1), align = "center"),
`Away% (Blend 2-way)` = reactable::colDef(format = reactable::colFormat(percent = TRUE, digits = 1), align = "center"),
`Home Median (Blend)` = reactable::colDef(
format = reactable::colFormat(digits = 1),
align = "center"
),
`Away Median (Blend)` = reactable::colDef(
format = reactable::colFormat(digits = 1),
align = "center"
),
`Total Median (Blend)` = reactable::colDef(
format = reactable::colFormat(digits = 1),
align = "center",
style = function(value) list(
background = pal_total(value),
color = if (is.na(value) || value < 46) "black" else "white"
)
),
Date        = reactable::colDef(align = "center"),
Day         = reactable::colDef(align = "center")
),
theme = reactable::reactableTheme(
borderColor = "#e5e7eb",
stripedColor = "#f9fafb",
highlightColor = "#eef2ff",
cellPadding = "8px 10px",
tableStyle = list(fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif")
)
)
} else {
inform("Interactive slate table skipped because 'reactable' is not available.")
}
log_dir <- file.path(getwd(), "run_logs")
run_id <- format(Sys.time(), "%Y%m%d_%H%M%S")
if (isTRUE(config$save_logs)) {
if (!dir.exists(log_dir)) dir.create(log_dir, recursive = TRUE)
cfg <- list(
SEASON = SEASON, WEEK_TO_SIM = WEEK_TO_SIM, N_TRIALS = N_TRIALS, SEED = SEED,
USE_SOS = USE_SOS, SOS_STRENGTH = SOS_STRENGTH,
USE_RECENCY_DECAY = USE_RECENCY_DECAY, RECENCY_HALFLIFE = RECENCY_HALFLIFE,
GLMM_BLEND_W_fixed = if (exists("GLMM_BLEND_W")) GLMM_BLEND_W else NA_real_,
RHO_SCORE = RHO_SCORE, PTS_CAP_HI = PTS_CAP_HI
)
saveRDS(cfg, file.path(log_dir, paste0("config_", run_id, ".rds")))
saveRDS(final, file.path(log_dir, paste0("final_", run_id, ".rds")))
saveRDS(games_ready, file.path(log_dir, paste0("games_ready_", run_id, ".rds")))
} else {
run_id <- NULL
}
list(
final = final,
games = games_ready,
config = config,
run_id = run_id,
reactable_available = reactable_available,
gt_available = gt_available
)
}
if (sys.nframe() == 0L) {
invisible(run_week_simulation())
}
warnings()
gc()
# ------------------------------------------------------------------------------
# NFL Week Simulation - SoS-weighted + QB Toggles + Outside Factors
# Requires: tidyverse, lubridate, nflreadr
# ------------------------------------------------------------------------------
ensure_dependencies <- function(pkgs,
load = FALSE,
install = !isFALSE(getOption("nfl.auto_install_deps", TRUE))) {
pkgs <- unique(pkgs)
if (!length(pkgs)) {
return(invisible(NULL))
}
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
if (length(missing) && install) {
repos <- getOption("repos")
if (is.null(repos) || identical(repos["CRAN"], "@CRAN@") || is.na(repos["CRAN"])) {
options(repos = c(CRAN = "https://cloud.r-project.org"))
}
utils::install.packages(missing, quiet = TRUE)
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
}
if (length(missing)) {
stop(
sprintf(
"Missing required package%s: %s. Install manually or set options(nfl.auto_install_deps = TRUE).",
if (length(missing) > 1) "s" else "",
paste(missing, collapse = ", ")
),
call. = FALSE
)
}
if (isTRUE(load)) {
for (pkg in pkgs) {
suppressPackageStartupMessages(
library(pkg, character.only = TRUE)
)
}
}
invisible(NULL)
}
ensure_dependencies(c(
"dplyr", "tibble", "purrr",
"lubridate", "nflreadr", "scales", "digest",
"glmmTMB", "nnet", "randtoolbox", "httr2", "rlang", "vctrs"
))
# ------------------------------------------------------------------------------
# NFL Week Simulation - SoS-weighted + QB Toggles + Outside Factors
# Requires: tidyverse, lubridate, nflreadr
# ------------------------------------------------------------------------------
ensure_dependencies <- function(pkgs,
load = FALSE,
install = !isFALSE(getOption("nfl.auto_install_deps", TRUE))) {
pkgs <- unique(pkgs)
if (!length(pkgs)) {
return(invisible(NULL))
}
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
if (length(missing) && install) {
repos <- getOption("repos")
if (is.null(repos) || identical(repos["CRAN"], "@CRAN@") || is.na(repos["CRAN"])) {
options(repos = c(CRAN = "https://cloud.r-project.org"))
}
utils::install.packages(missing, quiet = TRUE)
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
}
if (length(missing)) {
stop(
sprintf(
"Missing required package%s: %s. Install manually or set options(nfl.auto_install_deps = TRUE).",
if (length(missing) > 1) "s" else "",
paste(missing, collapse = ", ")
),
call. = FALSE
)
}
if (isTRUE(load)) {
for (pkg in pkgs) {
suppressPackageStartupMessages(
library(pkg, character.only = TRUE)
)
}
}
invisible(NULL)
}
ensure_dependencies(c(
"dplyr", "tibble", "purrr",
"lubridate", "nflreadr", "scales", "digest",
"glmmTMB", "nnet", "randtoolbox", "httr2", "rlang", "vctrs"
))
suppressPackageStartupMessages({
options(nfl.auto_install_deps = TRUE)
source("NFLbrier_logloss.R")
library(dplyr, warn.conflicts = FALSE)
library(tibble)
library(purrr)
library(lubridate)
library(nflreadr)
library(scales)
library(digest)
library(glmmTMB)   # NB GLMM
library(nnet)      # multinomial calibration
library(randtoolbox) # Sobol QMC
library(httr2)
})
# ------------------------------------------------------------------------------
# NFL Week Simulation - SoS-weighted + QB Toggles + Outside Factors
# Requires: tidyverse, lubridate, nflreadr
# ------------------------------------------------------------------------------
install.packages("dplyr")
# ------------------------------------------------------------------------------
# NFL Week Simulation - SoS-weighted + QB Toggles + Outside Factors
# Requires: tidyverse, lubridate, nflreadr
# ------------------------------------------------------------------------------
ensure_dependencies <- function(pkgs,
load = FALSE,
install = !isFALSE(getOption("nfl.auto_install_deps", TRUE))) {
pkgs <- unique(pkgs)
if (!length(pkgs)) {
return(invisible(NULL))
}
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
if (length(missing) && install) {
repos <- getOption("repos")
if (is.null(repos) || identical(repos["CRAN"], "@CRAN@") || is.na(repos["CRAN"])) {
options(repos = c(CRAN = "https://cloud.r-project.org"))
}
utils::install.packages(missing, quiet = TRUE)
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
}
if (length(missing)) {
stop(
sprintf(
"Missing required package%s: %s. Install manually or set options(nfl.auto_install_deps = TRUE).",
if (length(missing) > 1) "s" else "",
paste(missing, collapse = ", ")
),
call. = FALSE
)
}
if (isTRUE(load)) {
for (pkg in pkgs) {
suppressPackageStartupMessages(
library(pkg, character.only = TRUE)
)
}
}
invisible(NULL)
}
ensure_dependencies(c(
"dplyr", "tibble", "purrr",
"lubridate", "nflreadr", "scales", "digest",
"glmmTMB", "nnet", "randtoolbox", "httr2", "rlang", "vctrs"
))
install.packages(c("dplyr", "tibble", "purrr", "lubridate", "nflreadr", "scales", "digest", "glmmTMB", "httr2", "rlang", "vctrs"))
# ------------------------------------------------------------------------------
# NFL Week Simulation - SoS-weighted + QB Toggles + Outside Factors
# Requires: tidyverse, lubridate, nflreadr
# ------------------------------------------------------------------------------
ensure_dependencies <- function(pkgs,
load = FALSE,
install = !isFALSE(getOption("nfl.auto_install_deps", TRUE))) {
pkgs <- unique(pkgs)
if (!length(pkgs)) {
return(invisible(NULL))
}
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
if (length(missing) && install) {
repos <- getOption("repos")
if (is.null(repos) || identical(repos["CRAN"], "@CRAN@") || is.na(repos["CRAN"])) {
options(repos = c(CRAN = "https://cloud.r-project.org"))
}
utils::install.packages(missing, quiet = TRUE)
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
}
if (length(missing)) {
stop(
sprintf(
"Missing required package%s: %s. Install manually or set options(nfl.auto_install_deps = TRUE).",
if (length(missing) > 1) "s" else "",
paste(missing, collapse = ", ")
),
call. = FALSE
)
}
if (isTRUE(load)) {
for (pkg in pkgs) {
suppressPackageStartupMessages(
library(pkg, character.only = TRUE)
)
}
}
invisible(NULL)
}
ensure_dependencies(c(
"dplyr", "tibble", "purrr",
"lubridate", "nflreadr", "scales", "digest",
"glmmTMB", "nnet", "randtoolbox", "httr2", "rlang", "vctrs"
))
setwd("C:/Users/jviol/Downloads/nfl")
missing <- pkgs[!is_installed]
# ------------------------------------------------------------------------------
# NFL Week Simulation - SoS-weighted + QB Toggles + Outside Factors
# Requires: tidyverse, lubridate, nflreadr
# ------------------------------------------------------------------------------
ensure_dependencies <- function(pkgs,
load = FALSE,
install = !isFALSE(getOption("nfl.auto_install_deps", TRUE))) {
pkgs <- unique(pkgs)
if (!length(pkgs)) {
return(invisible(NULL))
}
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
if (length(missing) && install) {
repos <- getOption("repos")
if (is.null(repos) || identical(repos["CRAN"], "@CRAN@") || is.na(repos["CRAN"])) {
options(repos = c(CRAN = "https://cloud.r-project.org"))
}
utils::install.packages(missing, quiet = TRUE)
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
}
if (length(missing)) {
stop(
sprintf(
"Missing required package%s: %s. Install manually or set options(nfl.auto_install_deps = TRUE).",
if (length(missing) > 1) "s" else "",
paste(missing, collapse = ", ")
),
call. = FALSE
)
}
if (isTRUE(load)) {
for (pkg in pkgs) {
suppressPackageStartupMessages(
library(pkg, character.only = TRUE)
)
}
}
invisible(NULL)
}
# ------------------------------------------------------------------------------
# NFL Week Simulation - SoS-weighted + QB Toggles + Outside Factors
# Requires: tidyverse, lubridate, nflreadr
# ------------------------------------------------------------------------------
ensure_dependencies <- function(pkgs,
load = FALSE,
install = !isFALSE(getOption("nfl.auto_install_deps", TRUE))) {
pkgs <- unique(pkgs)
if (!length(pkgs)) {
return(invisible(NULL))
}
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
if (length(missing) && install) {
repos <- getOption("repos")
if (is.null(repos) || identical(repos["CRAN"], "@CRAN@") || is.na(repos["CRAN"])) {
options(repos = c(CRAN = "https://cloud.r-project.org"))
}
utils::install.packages(missing, quiet = TRUE)
is_installed <- vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)
missing <- pkgs[!is_installed]
}
if (length(missing)) {
stop(
sprintf(
"Missing required package%s: %s. Install manually or set options(nfl.auto_install_deps = TRUE).",
if (length(missing) > 1) "s" else "",
paste(missing, collapse = ", ")
),
call. = FALSE
)
}
if (isTRUE(load)) {
for (pkg in pkgs) {
suppressPackageStartupMessages(
library(pkg, character.only = TRUE)
)
}
}
invisible(NULL)
}
ensure_dependencies(c(
"dplyr", "tibble", "purrr",
"lubridate", "nflreadr", "scales", "digest",
"glmmTMB", "nnet", "randtoolbox", "httr2", "rlang", "vctrs"
))
